<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Justa Premium Email - Email Pribadi</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        }
        .main-content {
            background-color: #f8f9fa;
        }
        .email-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background-color: #ffffff;
            transition: all 0.2s ease-in-out;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }
        .email-body-content {
            all: unset;
        }
        .email-body-content * {
            all: revert;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 md:p-8 max-w-6xl">
        <header class="flex justify-between items-center mb-6">
            <div class="flex items-center space-x-3">
                <div class="gradient-bg p-2 rounded-lg">
                    <i class="fa-regular fa-envelope text-white text-2xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Justa Premium Email</h1>
            </div>
        </header>

        <main class="flex flex-col md:flex-row rounded-xl shadow-lg overflow-hidden">
            <aside class="w-full md:w-1/3 gradient-bg text-white p-8">
                <h2 class="text-2xl font-bold mb-2">Email Pribadi Akun Premium Anda.</h2>
                <p class="text-blue-100 mb-8">Segera Lindungi akun email Anda dengan kata sandi, lalu periksa kotak masuk dengan aman.</p>
                
                <div class="border-t border-blue-400 pt-6">
                    <h3 class="text-lg font-semibold mb-3">Cara Penggunaan:</h3>
                    <ol class="list-decimal list-inside space-y-2 text-blue-100">
                        <li>Masukkan <strong>nama email</strong> dan <strong>kata sandi</strong> yang Anda inginkan.</li>
                        <li>Klik <strong>"Lindungi Email"</strong> untuk mendaftarkan akun (hanya dilakukan sekali).</li>
                        <li>Klik <strong>"Periksa Kotak Masuk"</strong> untuk melihat email yang masuk ke alamat Anda.</li>
                    </ol>
                </div>
            </aside>

            <div class="w-full md:w-2/3 bg-white p-8">
                <div class="space-y-4 mb-8">
                    <div class="flex items-center justify-between p-3 border border-gray-300 rounded-lg bg-gray-50">
                        <span id="fullEmailDisplay" class="text-gray-700 font-medium truncate pr-2">email anda</span>
                        <button id="copyBtn" class="flex-shrink-0 flex items-center justify-center space-x-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-3 py-1.5 rounded-lg transition-colors text-sm">
                            <i class="fa-regular fa-copy"></i>
                            <span>Copy</span>
                        </button>
                    </div>

                    <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-2">
                        <input type="text" id="emailUser" class="form-input" placeholder="nama_email_anda">
                        <select id="emailDomain" class="form-select sm:w-auto">
                            <option value="@capcutpro.cloud">@capcutpro.cloud</option>
                            <option value="" disabled>Domain baru (segera hadir)</option>
                        </select>
                    </div>
                    <div>
                        <input type="password" id="emailPassword" class="form-input" placeholder="Masukkan kata sandi...">
                    </div>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                         <button id="protectBtn" class="w-full flex items-center justify-center space-x-2 bg-green-500 hover:bg-green-600 text-white font-semibold px-4 py-3 rounded-lg transition-colors">
                            <i class="fa-solid fa-shield-halved"></i>
                            <span>Lindungi Email</span>
                        </button>
                        <button id="checkBtn" class="w-full flex items-center justify-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-3 rounded-lg transition-colors">
                            <i class="fa-solid fa-inbox"></i>
                            <span>Periksa Kotak Masuk</span>
                        </button>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Kotak Masuk</h3>
                    <div id="refresh-container" class="hidden items-center">
                        <span id="last-refreshed" class="text-sm text-gray-500 mr-3"></span>
                        <button id="refreshBtn" class="flex items-center space-x-1.5 text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors">
                            <i class="fas fa-sync-alt"></i>
                            <span>Refresh</span>
                        </button>
                    </div>
                </div>
                <div id="inbox-container" class="space-y-3">
                    <div id="initial-message" class="text-center py-8 text-gray-500">
                        <i class="fa-solid fa-shield-halved text-3xl mb-2"></i>
                        <p>Daftarkan email dan kata sandi dengan tombol "Lindungi Email", atau periksa kotak masuk jika sudah terdaftar.</p>
                    </div>
                    <div id="loader" class="text-center py-8 hidden">
                        <i class="fas fa-spinner fa-spin text-3xl text-blue-500"></i>
                        <p class="mt-2 text-gray-500">Memproses permintaan...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-5 py-3 rounded-lg shadow-xl opacity-0 translate-y-3 transition-all duration-300">
        Pesan notifikasi.
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Element References ---
            const emailUser = document.getElementById('emailUser');
            const emailDomain = document.getElementById('emailDomain');
            const emailPassword = document.getElementById('emailPassword');
            const copyBtn = document.getElementById('copyBtn');
            const checkBtn = document.getElementById('checkBtn');
            const protectBtn = document.getElementById('protectBtn');
            const inboxContainer = document.getElementById('inbox-container');
            const initialMessage = document.getElementById('initial-message');
            const loader = document.getElementById('loader');
            const toast = document.getElementById('toast');
            const fullEmailDisplay = document.getElementById('fullEmailDisplay');
            const refreshContainer = document.getElementById('refresh-container');
            const lastRefreshed = document.getElementById('last-refreshed');
            const refreshBtn = document.getElementById('refreshBtn');

            // === PERUBAHAN DI SINI ===
            const API_URL = 'https://justa-premail-api.wayanbisnis65.workers.dev';
            
            let loggedInUser = null;

            // --- Helper Functions ---
            function showToast(message, isError = false) {
                toast.textContent = message;
                toast.className = `fixed bottom-5 right-5 px-5 py-3 rounded-lg shadow-xl transition-all duration-300 ${isError ? 'bg-red-600' : 'bg-gray-800'} text-white`;
                toast.classList.remove('opacity-0', 'translate-y-3');
                setTimeout(() => {
                    toast.classList.add('opacity-0', 'translate-y-3');
                }, 3000);
            }

            function getFullEmail() {
                const user = emailUser.value.trim();
                const domain = emailDomain.value;
                if (!domain) return null;
                return user ? `${user}${domain}` : null;
            }
            
            function updateFullEmailDisplay() {
                const fullEmail = getFullEmail();
                fullEmailDisplay.textContent = fullEmail || 'email anda';
            }

            function renderEmails(emails) {
                loader.classList.add('hidden');
                inboxContainer.innerHTML = ''; 

                if (!emails || emails.length === 0) {
                    inboxContainer.innerHTML = `<div class="text-center py-8 text-gray-500"><i class="fa-regular fa-envelope-open text-3xl mb-2"></i><p>Kotak masuk kosong.</p></div>`;
                    return;
                }

                emails.forEach(email => {
                    const emailEl = document.createElement('div');
                    emailEl.className = 'email-item bg-white border border-gray-200 p-4 rounded-lg cursor-pointer transition-all duration-200';
                    const emailBodyContent = `<div class="email-body-content">${email.body}</div>`;
                    emailEl.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-semibold text-gray-800">${email.from.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>
                                <p class="font-medium text-gray-600">${email.subject}</p>
                            </div>
                            <span class="text-xs text-gray-400">${email.time}</span>
                        </div>
                        <div class="email-body hidden mt-4 pt-4 border-t border-gray-200 text-gray-700">${emailBodyContent}</div>`;
                    inboxContainer.appendChild(emailEl);
                    emailEl.addEventListener('click', () => emailEl.querySelector('.email-body').classList.toggle('hidden'));
                });
            }

            // --- Core Logic ---

            async function handleProtectEmail() {
                const email = getFullEmail();
                const password = emailPassword.value;
                if (!email || !password) {
                    showToast('Nama email dan kata sandi tidak boleh kosong.', true);
                    return;
                }
                try {
                    const response = await fetch(`${API_URL}/api/protect`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Gagal melindungi email.');
                    showToast(data.message);
                } catch (error) {
                    showToast(error.message, true);
                }
            }
            
            async function fetchAndRenderEmails(email, password) {
                initialMessage.classList.add('hidden');
                inboxContainer.innerHTML = '';
                inboxContainer.appendChild(loader);
                loader.classList.remove('hidden');

                const refreshIcon = refreshBtn.querySelector('i');
                refreshIcon.classList.add('fa-spin');

                try {
                    const response = await fetch(`${API_URL}/api/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Gagal login.');
                    
                    renderEmails(data.emails);
                    lastRefreshed.textContent = `Diperbarui: ${new Date().toLocaleTimeString('id-ID')}`;
                    refreshContainer.classList.remove('hidden');
                    loggedInUser = { email, password };

                } catch (error) {
                    loader.classList.add('hidden');
                    showToast(error.message, true);
                    refreshContainer.classList.add('hidden');
                    loggedInUser = null;
                } finally {
                    refreshIcon.classList.remove('fa-spin');
                }
            }

            async function handleCheckInbox() {
                const email = getFullEmail();
                const password = emailPassword.value;
                if (!email || !password) {
                    showToast('Nama email dan kata sandi tidak boleh kosong.', true);
                    return;
                }
                await fetchAndRenderEmails(email, password);
            }
            
            async function handleRefresh() {
                if (!loggedInUser) {
                    showToast('Silakan periksa kotak masuk terlebih dahulu.', true);
                    return;
                }
                await fetchAndRenderEmails(loggedInUser.email, loggedInUser.password);
            }

            // --- Event Listeners ---
            protectBtn.addEventListener('click', handleProtectEmail);
            checkBtn.addEventListener('click', handleCheckInbox);
            refreshBtn.addEventListener('click', handleRefresh);
            emailUser.addEventListener('input', updateFullEmailDisplay);
            emailDomain.addEventListener('change', updateFullEmailDisplay);

            copyBtn.addEventListener('click', () => {
                const emailToCopy = getFullEmail();
                if (!emailToCopy) {
                    showToast('Harap isi nama email terlebih dahulu.', true);
                    return;
                }
                const tempInput = document.createElement('input');
                tempInput.value = emailToCopy;
                document.body.appendChild(tempInput);
                tempInput.select();
                try {
                    document.execCommand('copy');
                    showToast('Email disalin ke clipboard!');
                } catch (err) {
                    showToast('Gagal menyalin email!', true);
                } finally {
                    document.body.removeChild(tempInput);
                }
            });
        });
    </script>
</body>
</html>